<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Contraste Restobar: Cargar Excel y JSON</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.16.9/xlsx.full.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-icons/1.10.3/font/bootstrap-icons.min.css" rel="stylesheet">
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #FCFCFC;
            color: #070707;
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding-bottom: 50px;
        }
        h1 {
            color: #A6874A;
            margin: 20px;
            text-align: center;
        }
        .container {
            width: 90%;
            max-width: 1000px;
            margin: 20px 0;
        }
        .table-container {
            width: 100%;
            overflow-x: auto;
        }
        .btn-custom {
            background-color: #A6874A;
            color: #FCFCFC;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            margin-bottom: 20px;
            width: 100%;
            max-width: 200px;
        }
        .btn-custom:hover {
            background-color: #423C2F;
        }
        table {
            border-collapse: collapse;
            width: 100%;
            table-layout: fixed;
        }
        th, td {
            border: 2px solid #A6874A;
            padding: 10px;
            text-align: center;
            vertical-align: middle;
            word-wrap: break-word;
        }
        th {
            background-color: #A6874A;
            color: #FCFCFC;
            font-weight: bold;
        }
        th i {
            margin-left: 10px;
            cursor: pointer;
        }
        @media (max-width: 600px) {
            th, td {
                padding: 5px;
            }
            .btn-custom {
                font-size: 14px;
                padding: 8px 16px;
            }
            h1 {
                font-size: 24px;
            }
        }
    </style>
</head>
<body>
    <h1>Contraste Restobar: Cargar Excel y JSON</h1>
    <div class="container">
        <input type="file" id="excelFileInput" class="form-control mb-3" accept=".xlsx"/>
        <button onclick="handleFiles()" class="btn btn-custom">Cargar y Convertir</button>
        <div class="table-container">
            <table class="table table-striped table-bordered">
                <thead>
                    <tr>
                        <th>Producto <i class="bi bi-funnel-fill filter-icon" onclick="sortTable(0, 'string')"></i></th>
                        <th>Categoria <i class="bi bi-funnel-fill filter-icon" onclick="sortTable(1, 'string')"></i></th>
                        <th>Stock <i class="bi bi-funnel-fill filter-icon" onclick="sortTable(2, 'number')"></i></th>
                        <th>Stock Minimo <i class="bi bi-funnel-fill filter-icon" onclick="sortTable(3, 'number')"></i></th>
                        <th>Unid Medida <i class="bi bi-funnel-fill filter-icon" onclick="sortTable(4, 'string')"></i></th>
                        <th>Costo <i class="bi bi-funnel-fill filter-icon" onclick="sortTable(5, 'number')"></i></th>
                        <th>Frecuencia Compra <i class="bi bi-funnel-fill filter-icon" onclick="sortTable(6, 'string')"></i></th>
                        <th>Tipo de Proveedor <i class="bi bi-funnel-fill filter-icon" onclick="sortTable(7, 'string')"></i></th>
                        <th>Datos Proveedor <i class="bi bi-funnel-fill filter-icon" onclick="sortTable(8, 'string')"></i></th>
                    </tr>
                </thead>
                <tbody id="tableBody">
                    <!-- Aquí se insertarán los resultados -->
                </tbody>
            </table>
        </div>
    </div>

    <script>
        let currentSortColumn = null;
        let currentSortOrder = 'asc';

        function handleFiles() {
            const excelInput = document.getElementById('excelFileInput');

            if (!excelInput.files.length) {
                alert("Por favor, selecciona un archivo Excel primero.");
                return;
            }

            const excelFile = excelInput.files[0];

            // Leer y procesar el archivo Excel
            const excelReader = new FileReader();
            excelReader.onload = function(e) {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, { type: 'array' });
                const worksheet = workbook.Sheets[workbook.SheetNames[0]];
                let json = XLSX.utils.sheet_to_json(worksheet, { header: 1 });

                // Obtener la fila de encabezados correcta
                let headers = json[1]; // Suponiendo que la fila 1 es el encabezado correcto
                let headerIndex = 1;

                // Filtrar filas que contienen "Inventario"
                json = json.filter((row, index) => index > headerIndex && !row.some(cell => typeof cell === 'string' && cell.includes('Inventario')));

                // Columnas a eliminar
                const columnsToRemove = ["Espacio", "Rendimiento", "SubItems", "Cantidad Transformada"];
                const filteredHeaders = headers.filter(header => !columnsToRemove.includes(header));

                // Crear un array de objetos con los datos, excluyendo las columnas no deseadas
                const result = json.map(row => {
                    let obj = {};
                    filteredHeaders.forEach(header => {
                        let actualIndex = headers.indexOf(header);
                        obj[header] = row[actualIndex] !== undefined ? row[actualIndex] : '';
                    });
                    return obj;
                });

                // Obtener el JSON desde la URL
                fetch('https://raw.githubusercontent.com/jeanjn24/invrules/main/reglas.json')
                    .then(response => response.json())
                    .then(reglas => {
                        // Filtrar los objetos con valor vacío para la clave "Item"
                        reglas = reglas.filter(item => item.Item.trim() !== '');

                        // Combinar los datos
                        const combined = mergeJSON(result, reglas);

                        // Mostrar los datos en la tabla
                        displayDataInTable(combined);
                    })
                    .catch(error => {
                        console.error('Error al obtener el archivo JSON:', error);
                    });
            };

            excelReader.readAsArrayBuffer(excelFile);
        }

        function mergeJSON(result, reglas) {
            let combined = [...result];

            reglas.forEach(regla => {
                let itemIndex = combined.findIndex(item => item.Item === regla.Item);
                if (itemIndex !== -1) {
                    combined[itemIndex] = { ...combined[itemIndex], ...regla };
                } else {
                    combined.push(regla);
                }
            });

            return combined.filter(obj => obj.Item !== null && obj.Item !== undefined && obj.Item.trim() !== '' && obj["Datos Proveedor"] !== "PENDIENTE");
        }

        function displayDataInTable(data) {
            const tableBody = document.getElementById('tableBody');
            tableBody.innerHTML = '';

            data.forEach(row => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${row.Item || ''}</td>
                    <td>${row.Sección || ''}</td>
                    <td>${row.Cantidad !== undefined ? row.Cantidad : '0.0'}</td>
                    <td>${row["Cantidad Minima"] || ''}</td>
                    <td>${row.Unidad || ''}</td>
                    <td>${row["Costo Unitario"] || ''}</td>
                    <td>${row["Frecuencia Compra"] || ''}</td>
                    <td>${row["Tipo de Proveedor"] || ''}</td>
                    <td>${formatProveedorData(row["Datos Proveedor"])}</td>
                `;
                tableBody.appendChild(tr);
            });

            // Guardar los datos en el dataset de la tabla para facilitar el ordenamiento
            tableBody.dataset.originalData = JSON.stringify(data);
        }

        function formatProveedorData(data) {
            if (data.startsWith('https://')) {
                const shortData = data.length > 30 ? data.substring(0, 30) + '...' : data;
                return `<a href="${data}" target="_blank">${shortData}</a>`;
            }
            return data;
        }

        function sortTable(columnIndex, type) {
            const tableBody = document.getElementById('tableBody');
            const rows = Array.from(tableBody.rows);
            const sortedRows = rows.sort((a, b) => {
                let aText = a.cells[columnIndex].innerText.toLowerCase();
                let bText = b.cells[columnIndex].innerText.toLowerCase();

                if (type === 'number') {
                    aText = parseFloat(aText) || 0;
                    bText = parseFloat(bText) || 0;
                }

                if (aText < bText) {
                    return currentSortOrder === 'asc' ? -1 : 1;
                }
                if (aText > bText) {
                    return currentSortOrder === 'asc' ? 1 : -1;
                }
                return 0;
            });

            // Alternar el orden de clasificación
            currentSortOrder = currentSortOrder === 'asc' ? 'desc' : 'asc';

            // Limpiar y volver a agregar las filas ordenadas
            tableBody.innerHTML = '';
            sortedRows.forEach(row => tableBody.appendChild(row));
        }
    </script>
</body>
</html>
